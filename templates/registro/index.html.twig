<title>{% block title %}Registrarme{% endblock %}</title>

{{ encore_entry_link_tags('css/app') }}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/style.css') }}">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
{% endblock %}

{% block body %}
 
<div class="container mt-5 mb-5 text-center justify-content-center">
    <div class="card text-center">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link" href="/login">Iniciar sesión</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active">Registrarme</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <h1>¡Rellena este formulario!</h1>
            <small class="text-success">No compartiremos ninguno de tus datos con nadie</small>                    

            <!-- Inicio formulario -->
            {{ form_start(formulario) }}

                <!-- Mensaje registro exitoso -->
                {% for message in app.flashes('registrado') %}
                    <div class="alert alert-success text-center mt-3">
                        {{ message }}
                    </div>
                {% endfor %}

                <!-- Nombre -->
                <div class="row mt-4">
                    <div class="col">Nombre:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.nombre, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce el nombre'}}) }}
                        <span id="nombreError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Apellidos -->
                <div class="row mt-4">
                    <div class="col">Apellidos:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.apellidos, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce los apellidos'}}) }}
                        <span id="apellidosError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Dni -->
                <div class="row mt-4">
                    <div class="col">Dni:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.dni, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce el dni', 'maxlength': '9'}}) }}
                        <span id="dniError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Email -->
                <div class="row mt-4">
                    <div class="col">Email:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.email, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce el email'}}) }}
                        <span id="emailError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Contraseña -->
                <div class="row mt-4">
                    <div class="col">Contraseña:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.password, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce la contraseña','id': 'password'}}) }}
                        <span id="passwordError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Confirmar contraseña -->
                <div class="row mt-4">
                    <div class="col">Confirmar contraseña:</div>                        
                    <div class="col">
                        <input type="password" id="confirmPass" placeholder="Confirma la contraseña" class="form-control text-center"></input>
                        {{ form_widget(formulario.confirmPass, {'attr': {'class': 'd-none form-control'}}) }}
                        <span id="confirmPassError" class="text-danger"></span>
                    </div>                        
                </div>


            <!-- Ver contraseñas -->
                <div class="row mt-4">
                    <div class="col"></div>                        
                    <div class="col">
                        Ver contraseñas
                        <input type="checkbox" id="showPass"></input>
                    </div>                        
                </div>
               

                <!-- Fecha nacimiento -->
                <div class="row mt-4">
                    <div class="col">Fecha de nacimiento:</div>                        
                    <div class="col">
                        <input type="date" id="fechaNacimiento" class="form-control text-center"></input>
                        <span id="fechaError" class="text-danger"></span>
                        {{ form_widget(formulario.fechaNacimiento, {'attr': {'class': 'd-none form-control'} }) }}
                        
                    </div>                        
                </div>

                <hr><span class="text-success">Dirección</span>

                <!-- Calle -->
                <div class="row mt-4">
                    <div class="col">Calle:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.calle, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce la calle'}}) }}
                        <span id="calleError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Localidad -->
                <div class="row mt-4">
                    <div class="col">Localidad:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.localidad, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce la localidad'}}) }}
                        <span id="localidadError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Provincia -->
                <div class="row mt-4">
                    <div class="col">Provincia:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.provincia, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce la provincia'}}) }}
                        <span id="provinciaError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Código postal -->
                <div class="row mt-4">
                    <div class="col">Código postal:</div>                        
                    <div class="col">
                        {{ form_widget(formulario.cp, {'attr': {'class': 'form-control text-center', 'placeholder': 'Introduce el codigo postal', 'maxlength': '5'}}) }}
                        <span id="cpError" class="text-danger"></span>
                    </div>                        
                </div>

                <!-- Botón de registrar -->
                <div class="row mt-4">
                    <div class="col">
                        {{ form_widget(formulario.Registrarme, {'attr': {'class': 'form-control'}}) }}
                        <div class="col">
                            <small id="botonError" class="text-danger"></small>
                        </div>  
                    </div>  
                </div>  

            <!-- Fin formulario -->
            {{ form_end(formulario) }}
        </div>  
    </div>

    <p class="mt-5 mb-3 text-muted">&copy; IF-ormáticos FC 2020</p>
</div>
{% endblock %}

{% block javascripts %}
    <script>
        {# Variables formulario symfony #}
        var fecha_nacimiento = document.getElementById("fechaNacimiento");
        var fecha_dia = document.getElementById("usuarios_fechaNacimiento_day");
        var fecha_mes = document.getElementById("usuarios_fechaNacimiento_month");
        var fecha_year = document.getElementById("usuarios_fechaNacimiento_year");
        var fecha = document.getElementById("usuarios_fechaNacimiento");
        var nombre = document.getElementById("usuarios_nombre");
        var apellidos = document.getElementById("usuarios_apellidos");
        var dni = document.getElementById("usuarios_dni");
        var email = document.getElementById("usuarios_email");
        var password = document.getElementById("usuarios_password");
        var confirmPass2 = document.getElementById("usuarios_confirmPass");
        var confirmPass = document.getElementById("confirmPass");
        var calle = document.getElementById("usuarios_calle");
        var localidad = document.getElementById("usuarios_localidad");
        var provincia = document.getElementById("usuarios_provincia");
        var cp = document.getElementById("usuarios_cp");
        var boton_registrar = document.getElementById("usuarios_Registrarme");

        {# Variables errores #}
        var nombre_error = document.getElementById("nombreError");
        var apellidos_error = document.getElementById("apellidosError");
        var dni_error = document.getElementById("dniError");
        var email_error = document.getElementById("emailError");
        var fecha_error = document.getElementById("fechaError");
        var password_error = document.getElementById("passwordError");
        var confirmPass_error = document.getElementById("confirmPassError");
        var calle_error = document.getElementById("calleError");
        var localidad_error = document.getElementById("localidadError");
        var provincia_error = document.getElementById("provinciaError");
        var cp_error = document.getElementById("cpError");
        var showPass = document.getElementById("showPass");
        var boton_error = document.getElementById("botonError");

        {# Variables comprobación campos rellenados #}
        var nombreFill = false;
        var apellidosFill = false;
        var dniFill = false;
        var emailFill = false;
        var contraseñaFill = false;
        var confirmarContraseñaFill = false;
        var fechaNacimientoFill = false;
        var calleFill = false;
        var localidadFill = false;
        var provinciaFill = false;
        var cpFill = false;
        var todoOk = false;

        {# Puntero body #}
        document.querySelector('body').style.cursor = "pointer";
        boton_registrar.className="btn btn-danger";

        {# Validaciones #}

        {# Validación Fecha #}
        fecha_nacimiento.onchange = () => {
            let date = new Date(fecha_nacimiento.value);
            fecha_dia.value = date.getDate();
            fecha_mes.value = date.getMonth()+1;
            fecha_year.value = date.getFullYear();
       
            if(fecha_dia.value !== '' && fecha_mes.value !== '' && fecha_year.value !== ''){
                if(fecha_year.value === '2020'){
                    fechaNacimientoFill = false;
                    fecha_nacimiento.style.borderColor = "red";
                    fecha_error.innerHTML = "Comprueba bien el año elegido";                
                } else {
                    fechaNacimientoFill = true;
                    console.log('Fecha: '+fechaNacimientoFill);
                    fecha_nacimiento.style.borderColor = "";
                    fecha_error.innerHTML = "";
                }                
            } else {
                fechaNacimientoFill = false;
                console.log('Fecha: '+fechaNacimientoFill);
            }
            console.log('Fecha: '+fechaNacimientoFill);
        }

        {# Mostrar/Ocultar contraseña #}
        showPass.onclick = () => {
            if(showPass.checked) {
                password.type = "text";
                confirmPass.type = "text";
            } else {
                password.type = "password";
                confirmPass.type = "password";
            }
        }
       
        {# Validación Nombre #}
        nombre_error.innerHTML = "";
        nombre.onkeyup = () => {
            const regExpNombre =/^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$/;
            if(regExpNombre.test(nombre.value)){
                nombre_error.innerHTML = "";
                nombre.style.borderColor = "";
                nombreFill = true;
                console.log('Nombre: '+nombreFill);
            }
            if(!regExpNombre.test(nombre.value)){
                nombre_error.innerHTML = "El campo debe tener una cadena de caracteres";
                nombre.style.borderColor = "red";
                nombreFill = false;
                console.log('Nombre: '+nombreFill);               
            }
            if(nombre.value == ""){
                nombre_error.innerHTML = "El campo no puede estar vacío";
                nombre.style.borderColor = "red";
                nombreFill = false;
                console.log('Nombre: '+nombreFill);
            }
        }
       
        {# Validación Apellidos #}
        apellidos_error.innerHTML = "";
        apellidos.onkeyup = () => {
            const regExpApellidos =/^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$/;
           
            if(regExpApellidos.test(apellidos.value)){
                apellidos_error.innerHTML = "";
                apellidos.style.borderColor = "";
                apellidosFill = true;
                console.log('Apellidos: '+apellidosFill);
            }
            if(!regExpApellidos.test(apellidos.value)){
                apellidos_error.innerHTML = "El campo debe tener una cadena de caracteres";
                apellidos.style.borderColor = "red";
                apellidosFill = false;
                console.log('Apellidos: '+apellidosFill);
            }
            if(apellidos.value == ""){
                apellidos_error.innerHTML = "El campo no puede estar vacío";
                apellidos.style.borderColor = "red";
                apellidosFill = false;
                console.log('Apellidos: '+apellidosFill);
            }
        }
               
        {# Validación DNI #}
        dni_error.innerHTML = "";
        dni.onkeyup = () => {
            const regExpDni =/^[0-9]{8}[A-Za-z]$/i;
            var ruta = '/comprobar-dni'

            if(regExpDni.test(dni.value)){
                dniFill = true;
                console.log('DNI: '+dniFill);
                console.log(dni.value)
                $.ajax({
                    type: 'POST',
                    url: ruta,
                    data: ({dni: dni.value.toString()}),
                    async: true,
                    dataType: 'json',
                    success: function (data) {
                        comprobarDni(data)
                    }
                })
                dni_error.innerHTML = "";
                dni.style.borderColor = "";
            }
            if(!regExpDni.test(dni.value)){
                dni_error.innerHTML = "El campo debe contener 8 números y 1 letra";
                dni.style.borderColor = "red";
                dniFill = true;
                console.log('DNI: '+dniFill);
            }
            if(dni.value == ""){
                dni_error.innerHTML = "El campo no puede estar vacío";
                dni.style.borderColor = "red";
                dniFill = false;
                console.log('DNI: '+dniFill);
            }
        }

        function comprobarDni(valor) {
            // dni
            if (valor) {
                console.log('DNI repetido');
                dni_error.innerHTML = "Este DNI ya existe, introduce otro";
                dni.style.borderColor = "red";
                dniFill = false;
                console.log('DNI: '+dniFill);
            } else {
                console.log('DNI correcto');
                dni_error.innerHTML = "";
                dni.style.borderColor = "";
                dniFill = true;
                console.log('DNI: '+dniFill);
            }
        }
               
        {# Validación Email #}
        email_error.innerHTML = "";
        email.onkeyup = () => {
            const regExpEmail =/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.([a-zA-Z]{2,4})+$/;
            var ruta = '/comprobar-email'

            if(regExpEmail.test(email.value)){
                console.log(email.value)
                emailFill = true;
                console.log('email: '+emailFill);
                $.ajax({
                    type: 'POST',
                    url: ruta,
                    data: ({email: email.value.toString()}),
                    async: true,
                    dataType: 'json',
                    success: function (data) {
                        comprobarEmail(data)
                    }
                })
                email_error.innerHTML = "";
                email.style.borderColor = "";
            }
            if(!regExpEmail.test(email.value)){
                email_error.innerHTML = "El campo debe tener formato email";
                email.style.borderColor = "red";
                emailFill = false;
                console.log('email: '+emailFill);
            }
            if(email.value == ""){
                email_error.innerHTML = "El campo no puede estar vacío";
                email.style.borderColor = "red";
                emailFill = false;
                console.log('email: '+emailFill);
            }
        }

        function comprobarEmail(valor) {
            // email
            if (valor) {
                console.log('email repetido');
                email_error.innerHTML = "Este email ya existe, introduce otro";
                email.style.borderColor = "red";
                emailFill = false;
                console.log('email: '+emailFill);
            } else {
                console.log('email correcto');
                email_error.innerHTML = "";
                email.style.borderColor = "";
                emailFill = true;
                console.log('email: '+emailFill);
            }
        }

        {# Validación Contraseña #}
        password_error.innerHTML = "";
        password.onkeyup = () => {
            if(password.value === ''){
                password_error.innerHTML = "El campo no puede estar vacío";
                password.style.borderColor = "red";
                contraseñaFill = false;
                console.log('Contraseña: '+contraseñaFill);
                confirmPass_error.innerHTML = "El campo no puede estar vacío";
                confirmPass.style.borderColor = "red";
                confirmarContraseñaFill = false;
                console.log('Confirmar Contraseña: '+confirmarContraseñaFill);
            } else {
                password_error.innerHTML = "";
                password.style.borderColor = "";
            }
            if(password.value) {
                if(confirmPass.value) {
                    console.log('Valor pass: '+password.value);
                    password.style.borderColor = "";
                    password_error.innerHTML = "";
                    confirmPass_error.innerHTML = "";
                    confirmPass.value = '';
                    confirmPass.style.borderColor = "";
                    contraseñaFill = true;
                    console.log('Contraseña: '+contraseñaFill);
                } else {
                    confirmPass_error.innerHTML = "Las contraseñas no coinciden";
                    confirmPass.style.borderColor = "red";
                    confirmarContraseñaFill = false;
                    console.log('Confirmar Contraseña: '+confirmarContraseñaFill);
                }
            }
        }

        {# Validación Confirmar contraseña #}   
        confirmPass_error.innerHTML = "";   
        confirmPass.onkeyup = () => {
            if(password.value){
                if(confirmPass.value === '') {
                    confirmPass_error.innerHTML = "El campo no puede estar vacío";
                    confirmPass.style.borderColor = "red";
                    confirmarContraseñaFill = false;
                    console.log('Confirmar Contraseña: '+confirmarContraseñaFill);
                }
                if(confirmPass.value != password.value){
                    confirmPass_error.innerHTML = "Las contraseñas no coinciden";
                    confirmPass.style.borderColor = "red";
                    confirmarContraseñaFill = false;
                    console.log('Confirmar Contraseña: '+confirmarContraseñaFill);
                }
                if(confirmPass.value == password.value) {
                    confirmPass_error.innerHTML = "";
                    confirmPass.style.borderColor = "";
                    confirmarContraseñaFill = true;
                    console.log('Confirmar Contraseña: '+confirmarContraseñaFill);
                }
            } else {
                confirmPass_error.innerHTML = "Primero debes ingresar la contraseña";
                confirmPass.style.borderColor = "red";
            }
        }       

        {# Validación Calle #}
        calle_error.innerHTML = "";
        calle.onkeyup = () => {
            const regExpCalle =/^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+[0-9]+$/;
            if(regExpCalle.test(calle.value)){
                calle_error.innerHTML = "";
                calle.style.borderColor = "";
                calleFill = true;
                console.log('Calle: '+calleFill);
            }
            if(!regExpCalle.test(calle.value)){
                calle_error.innerHTML = "El campo debe tener una cadena de caracteres y un número";
                calle.style.borderColor = "red";
                calleFill = false;
                console.log('Calle: '+calleFill);
            }
            if(calle.value == ""){
                calle_error.innerHTML = "El campo no puede estar vacío";
                calle.style.borderColor = "red";
                calleFill = false;
                console.log('Calle: '+calleFill);
            }
        }

        {# Validación Localidad #}
        localidad_error.innerHTML = "";
        localidad.onkeyup = () => {
            const regExpLocalidad =/^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$/;
            if(regExpLocalidad.test(localidad.value)){
                localidad_error.innerHTML = "";
                localidad.style.borderColor = "";
                localidadFill = true;
                console.log('Localidad: '+localidadFill);
            }
            if(!regExpLocalidad.test(localidad.value)){
                localidad_error.innerHTML = "El campo debe tener una cadena de caracteres";
                localidad.style.borderColor = "red";
                localidadFill = false;
                console.log('Localidad: '+localidadFill);
            }
            if(localidad.value == ""){
                localidad_error.innerHTML = "El campo no puede estar vacío";
                localidad.style.borderColor = "red";
                localidadFill = false;
                console.log('Localidad: '+localidadFill);
            }
        }

        {# Validación Provincia #}
        provincia_error.innerHTML = "";
        provincia.onkeyup = () => {
            const regExpLocalidad =/^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$/;
            if(regExpLocalidad.test(provincia.value)){
                provincia_error.innerHTML = "";
                provincia.style.borderColor = "";
                provinciaFill = true;
                console.log('Provincia: '+provinciaFill);
            }
            if(!regExpLocalidad.test(provincia.value)){
                provincia_error.innerHTML = "El campo debe tener una cadena de caracteres";
                provincia.style.borderColor = "red";
                provinciaFill = false;
                console.log('Provincia: '+provinciaFill);
            }
            if(provincia.value == ""){
                provincia_error.innerHTML = "El campo no puede estar vacío";
                provincia.style.borderColor = "red";
                provinciaFill = false;
                console.log('Provincia: '+provinciaFill);
            }
        }

        {# Validación Código postal #}
        cp_error.innerHTML = "";
        cp.onkeyup = () => {
            const regExpCp =/^(?:0[1-9]\d{3}|[1-4]\d{4}|5[0-2]\d{3})$/;
            if(regExpCp.test(cp.value)){
                cp_error.innerHTML = "";
                cp.style.borderColor = "";
                cpFill = true;
                console.log('CP: '+cpFill);
            }
            if(!regExpCp.test(cp.value)){
                cp_error.innerHTML = "El campo debe tener 5 numeros comprendidos entre 01000 y 52999";
                cp.style.borderColor = "red";
                cpFill = false;
                console.log('CP: '+cpFill);
            }
            if(cp.value == ""){
                cp_error.innerHTML = "El campo no puede estar vacío";
                cp.style.borderColor = "red";
                cpFill = false;
                console.log('CP: '+cpFill);
            }
        }

        onchange = () => {
            if(nombreFill && apellidosFill && dniFill && emailFill && contraseñaFill && confirmarContraseñaFill && fechaNacimientoFill && calleFill && localidadFill && provinciaFill && cpFill) {
                boton_registrar.className="btn btn-success";
                boton_registrar.style.cursor = "pointer";
                boton_registrar.disabled = false;
                boton_error.innerHTML = "";
                console.log('Comprobación de todo: OK');
            } else {
                boton_registrar.className="btn btn-danger";
                boton_registrar.style.cursor = "not-allowed";
                console.log('Comprobación de todo: KO');
                boton_registrar.disabled = true;
            }
        }
                
        boton_registrar.className="btn btn-success";
        boton_registrar.onmouseover = () => {
            if(nombreFill && apellidosFill && dniFill && emailFill && contraseñaFill && confirmarContraseñaFill && fechaNacimientoFill && calleFill && localidadFill && provinciaFill && cpFill) {
                boton_registrar.className="btn btn-success";
                boton_registrar.style.cursor = "pointer";
                boton_error.innerHTML = "";
                console.log('Estoy pasando el mouse por el botón verde');
                todoOk = true;
            } else {
                boton_registrar.className="btn btn-danger";
                boton_registrar.style.cursor = "not-allowed";
                boton_error.innerHTML = "Antes de pulsarme debes rellenar TODOS los campos correctamente";
                console.log('Estoy pasando el mouse por el botón rojo');
            }     
        }

        boton_registrar.onclick = () => { 
            if(!todoOk){
                boton_registrar.disabled = true;
            }
            if(!nombre.value){
                nombre.style.borderColor = "red";
                nombre_error.innerHTML = "Debes introducir un nombre";
            } 
            if(!apellidos.value) {
                apellidos.style.borderColor = "red";
                apellidos_error.innerHTML = "Debes introducir unos apellidos";
            }
            if(!dni.value) {
                dni.style.borderColor = "red";
                dni_error.innerHTML = "Debes introducir un dni";
            }
            if(!email.value) {
                email.style.borderColor = "red";
                email_error.innerHTML = "Debes introducir un email";
            }
            if(!password.value) {
                password.style.borderColor = "red";
                password_error.innerHTML = "Debes introducir una contraseña";
            } 
            if(!confirmPass.value) {
                confirmPass.style.borderColor = "red";
                confirmPass_error.innerHTML = "Debes repetir la contraseña aquí";
            }
            if(!calle.value) {
                calle.style.borderColor = "red";
                calle_error.innerHTML = "Debes introducir una calle";
            }
            if(!localidad.value) {
                localidad.style.borderColor = "red";
                localidad_error.innerHTML = "Debes introducir una localidad";
            }
            if(!provincia.value) {
                provincia.style.borderColor = "red";
                provincia_error.innerHTML = "Debes introducir una provincia";
            }
            if(!cp.value) {
                cp.style.borderColor = "red";
                cp_error.innerHTML = "Debes introducir un código postal";
            }

            if(fecha_nacimiento.value) {
                fecha_nacimiento.style.borderColor = "";
                fecha_error.innerHTML = "";
                fechaNacimientoFill = true;
            } else {
                fecha_dia.value = 1;
                fecha_mes.value = 1;
                fecha_year.value = 1900;
                fecha_nacimiento.style.borderColor = "red";
                fecha_error.innerHTML = "Debes introducir una fecha";
            }
        }
    </script>
{% endblock %}